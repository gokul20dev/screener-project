<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Digi Screener</title>
    <link rel="stylesheet" href="../common/css/loader.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" 
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
    <style>
        :root {
            --primary: #1877f2;
            --primary-light: #e7f3ff;
            --text: #333333;
            --text-grey: #718096;
        }

        body {
            background-color: #f5f8fa;
            font-family: "Inter", system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #forgot-password-form {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            position: relative;
            z-index: 2;
        }

        .forgot-password-card {
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 2.5rem 2.25rem;
            width: 100%;
            max-width: 440px;
            transition: all 0.3s ease;
            animation: slideUp 0.5s ease forwards;
            position: relative;
            overflow: hidden;
        }

        /* Add decorative top border */
        .forgot-password-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--primary), #5b21b6);
        }

        .forgot-password-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .college-logo {
            max-width: 80px;
            max-height: 80px;
            margin-right: 1rem;
            object-fit: contain;
        }

        .college-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.75rem;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .college-text {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .college-name {
            font-size: 1.3rem;
            margin: 0;
            color: var(--text);
            font-weight: 600;
        }

        .college-code {
            font-size: 0.9rem;
            color: var(--text-grey);
            margin-top: 0.25rem;
        }

        .reset-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-top: 0.5rem;
            margin-bottom: 0.75rem;
            color: #1e293b;
            text-align: center;
        }

        .reset-subtitle {
            font-size: 1rem;
            color: var(--text-grey);
            margin-bottom: 2rem;
            text-align: center;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 1.25rem;
            z-index: 1;
        }

        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            z-index: 1;
            opacity: 0.7;
        }

        input {
            width: 100%;
            padding: 14px 12px 14px 40px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            height: 50px;
            outline: none;
            transition: all 0.2s ease;
            color: #4a5568;
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.15);
        }

        input::placeholder {
            color: #a0aec0;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 2rem;
        }

        .back-button, .reset-button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.01em;
        }

        .back-button {
            background-color: #f1f5f9;
            color: #475569;
            font-weight: 500;
        }

        .reset-button {
            background-color: #000;
            color: white;
            font-weight: 500;
        }

        .reset-button:hover {
            background-color: #333;
            transform: translateY(-2px);
        }

        .back-button:hover {
            background-color: #e2e8f0;
            transform: translateY(-2px);
        }

        .error-message, .success-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 1.25rem;
            font-size: 0.9rem;
            display: none;
            line-height: 1.5;
        }

        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
            border-left: 4px solid #ef4444;
        }

        .success-message {
            background-color: #dcfce7;
            color: #15803d;
            border-left: 4px solid #22c55e;
        }

        .show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toggle-password {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .toggle-password:hover {
            opacity: 1;
        }

        /* Make readonly input clearer */
        input[readonly] {
            background-color: #f8fafc;
            color: #64748b;
            border-color: #e2e8f0;
        }

        /* Responsive design */
        @media (max-width: 480px) {
            .forgot-password-card {
                padding: 1.5rem;
            }
            
            .college-logo {
                max-width: 60px;
                max-height: 60px;
            }
            
            .college-name {
                font-size: 1.1rem;
            }
            
            .reset-title {
                font-size: 1.3rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .back-button, .reset-button {
                width: 100%;
            }
        }

        /* Add a placeholder for colleges without logos */
        .logo-placeholder {
            width: 70px;
            height: 70px;
            background-color: #f1f5f9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .logo-placeholder i {
            font-size: 2rem;
            color: #64748b;
        }

        /* Improve button focus states */
        .back-button:focus, .reset-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* Add animation to the card */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Add subtle decorative elements */
        .forgot-password-card::after {
            content: "";
            position: absolute;
            bottom: -50px;
            right: -50px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(219, 234, 254, 0.3);
            z-index: 0;
        }

        /* Add a small decoration to the top of the card */
        .card-decoration {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(219, 234, 254, 0.5);
        }

        .card-decoration:before {
            content: "";
            position: absolute;
            top: -5px;
            right: 15px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: rgba(199, 210, 254, 0.5);
        }

        /* Token Expiry Styles */
        .expired-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem 2rem;
            text-align: center;
            animation: fadeInScale 0.5s ease-out;
            background: #fff;
            border-radius: 12px;
        }

        .expired-icon {
            margin-bottom: 1.5rem;
        }

        .expired-icon i {
            font-size: 64px;
            color: #ff9900;
            animation: pulse 2s infinite ease-in-out;
        }

        .expired-content {
            max-width: 400px;
        }

        .expired-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        .expired-text {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }

        .countdown-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
        }

        .countdown-text {
            font-size: 1.1rem;
            color: #64748b;
        }

        .countdown-number {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ff9900;
            min-width: 1.5rem;
        }

        /* Animations */
        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Responsive Styles */
        @media (max-width: 480px) {
            .expired-message {
                padding: 2rem 1.5rem;
            }

            .expired-icon i {
                font-size: 48px;
            }

            .expired-title {
                font-size: 1.5rem;
            }

            .expired-text {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="forgot-password-form">
        <div class="forgot-password-card">
            <div class="card-decoration"></div>
            <div id="college-info-container">
                <div class="reset-title">Reset Your Password</div>
                <div class="reset-subtitle">Enter new password below</div>
            </div>

            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>

            <div class="input-wrapper">
                <i class="fas fa-envelope input-icon"></i>
                <input type="email" id="email" placeholder="Email address" readonly>
            </div>
            
            <div class="input-wrapper">
                <i class="fas fa-lock input-icon"></i>
                <input type="password" id="password" placeholder="New password">
                <i class="fas fa-eye toggle-password"></i>
            </div>
            
            <div class="input-wrapper">
                <i class="fas fa-lock input-icon"></i>
                <input type="password" id="confirm-password" placeholder="Confirm new password">
                <i class="fas fa-eye toggle-password"></i>
            </div>

            <div class="action-buttons">
                <button id="back-button" class="back-button">Back to Login</button>
                <button id="reset-button" class="reset-button">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- jQuery and other libraries -->
    <script src="../common/commonLibaries/jquery-3.6.0.min.js"></script>
    <script src="../common/js/loader.js"></script>
    <script src="../common/js/variable.js"></script>
    <script src="../common/js/common.js"></script>
    <script src="../common/js/commonApi.js"></script>
    
    <script>
        $(document).ready(function() {
            // Parse URL query parameters
            const urlParams = new URLSearchParams(window.location.search);
            const email = urlParams.get('email');
            const accessToken = urlParams.get('token');
            const accountId = urlParams.get('accountId');
            
            // Validate required parameters
            if (!email || !accessToken || !accountId) {
                handleInvalidLink();
                return;
                return;
            }
            
            // Pre-fill and disable email field
            $("#email").val(email).prop("readonly", true).css("background-color", "#f8f9fa");
            
            // First verify the token is not expired
            $("#error-message").removeClass("show");
            $("#success-message").removeClass("show");
            $("#reset-button").prop("disabled", true).text("Verifying link...");
            
            // Verify token validity
            makeApiCall({
                url: `${base_url}/user/verify`,
                method: "PUT",
                isApiKey: true,
                data: JSON.stringify({
                    token: accessToken
                }),
                successCallback: function(response) {
                if(response?.message === "TOKEN_EXPIRED" && response?.data?.isValid === false){
                    // Call the handleExpiredToken function instead of directly modifying HTML
                    handleExpiredToken();
                } else {
                    // Token is valid, enable the form
                    $("#reset-button").prop("disabled", false).text("Reset Password");
                    // Continue with college info fetch
                    fetchCollegeInfo();
                }
                },
                errorCallback: function(errorMessage) {
                    handleInvalidLink();
                }
            });

            // Function to fetch college details
            function fetchCollegeInfo() {
                makeApiCall({
                    url: `${ACCOUNT_END_POINT}?id=${accountId}`,
                    method: "GET",
                    token: accessToken,
                    successCallback: function(response) {
                        if (response.data && response.data.length > 0) {
                            const college = response.data[0];
                            
                            // Update page with college info
                            const collegeHtml = `
                            <div class="college-info">
                                ${college.settings?.logo?.url ? 
                                `<img src="${college.settings.logo.url}" class="college-logo" alt="${college.name} Logo">` : 
                                `<div class="logo-placeholder"><i class="fas fa-building"></i></div>`}
                                <div class="college-text">
                                    <h2 class="college-name">${college.name}</h2>
                                    <div class="college-code">Code: ${college.code}</div>
                                </div>
                            </div>
                            <div class="reset-title">Reset Your Password</div>
                            <div class="reset-subtitle">Enter new password below</div>`;
                            
                            // Replace the college info container content
                            $("#college-info-container").html(collegeHtml);
                            
                            // Set primary color if available
                            if (college.settings?.colors?.primary) {
                                document.documentElement.style.setProperty('--primary', college.settings.colors.primary);
                            }
                        }
                    },
                    errorCallback: function() {
                        console.log("Could not fetch college details");
                    }
                });
            }
            
            // Toggle password visibility
            $(document).on("click", ".toggle-password", function() {
                const icon = $(this);
                const passwordInput = icon.siblings("input");
                const isPassword = passwordInput.attr("type") === "password";

                passwordInput.attr("type", isPassword ? "text" : "password");
                icon.toggleClass("fa-eye fa-eye-slash");
            });
            
            // Handle back button click
            $("#back-button").on("click", function() {
                window.location.href = "index.html";
            });

            // Handle reset password button click
            $("#reset-button").on("click", function() {
                const password = $("#password").val();
                const confirmPassword = $("#confirm-password").val();
                
                // Clear previous messages
                $("#error-message").removeClass("show").text("");
                $("#success-message").removeClass("show").text("");
                
                // Validate inputs
                if (!password) {
                    $("#error-message").addClass("show").text("Please enter a new password.");
                    return;
                }
                
                if (password !== confirmPassword) {
                    $("#error-message").addClass("show").text("Passwords do not match.");
                    return;
                }
                
                // Show loading state
                const originalText = $(this).text();
                $(this).text("Processing...").prop("disabled", true);
                
                // Call the reset password API with token
                makeApiCall({
                    url: `${USER_END_POINT}/reset-password`,
                    method: "PUT",
                    token: accessToken,
                    data: JSON.stringify({
                        password: password,
                    }),
                    successCallback: function(response) {
                        $("#reset-button").text(originalText).prop("disabled", false);
                        $("#success-message").addClass("show").text("Password has been reset successfully. You can now login with your new password.");
                        $("#password").val("");
                        $("#confirm-password").val("");
                        
                        // Redirect to login page after 3 seconds
                        setTimeout(function() {
                            window.location.href = "index.html";
                        }, 3000);
                    },
                    errorCallback: function(errorMessage) {
                        $("#reset-button").text(originalText).prop("disabled", false);
                        $("#error-message").addClass("show").text(errorMessage);
                    }
                });
            });
            
            // Add Enter key functionality for all fields
            $("#password, #confirm-password").on("keypress", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    $("#reset-button").click();
                }
            });
        });

        // Redirect functionality
        function handleExpiredToken() {
            let secondsLeft = 15;
            
            $(".forgot-password-card").html(`
                <div class="expired-message">
                    <div class="expired-icon">
                        <i class="fa-solid fa-circle-exclamation"></i>
                    </div>
                    <div class="expired-content">
                        <h2 class="expired-title">Your session has expired</h2>
                        <p class="expired-text">Please submit the forgot password request again.</p>
                        <div class="countdown-wrapper">
                            <span class="countdown-text">Redirecting in</span>
                            <span id="timer" class="countdown-number">${secondsLeft}</span>
                            <span class="countdown-text">seconds...</span>
                        </div>
                    </div>
                </div>
            `);

            const timer = setInterval(() => {
                secondsLeft--;
                $("#timer").text(secondsLeft);
                
                if (secondsLeft <= 0) {
                    clearInterval(timer);
                    window.location.href = `${ window.location.origin}/fullscreenexam/index.html`;
                }
            }, 1000);
        }

        // Handle invalid link
        function handleInvalidLink() {
            let secondsLeft = 15;
            
            $(".forgot-password-card").html(`
                <div class="expired-message">
                    <div class="expired-icon">
                        <i class="fa-solid fa-exclamation-triangle"></i>
                    </div>
                    <div class="expired-content">
                        <h2 class="expired-title">Invalid Password Reset Link</h2>
                        <p class="expired-text">Please request a new password reset link.</p>
                        <div class="countdown-wrapper">
                            <span class="countdown-text">Redirecting in</span>
                            <span id="timer" class="countdown-number">${secondsLeft}</span>
                            <span class="countdown-text">seconds...</span>
                        </div>
                    </div>
                </div>
            `);

            const timer = setInterval(() => {
                secondsLeft--;
                $("#timer").text(secondsLeft);
                
                if (secondsLeft <= 0) {
                    clearInterval(timer);
                    window.location.href = `${ window.location.origin}/fullscreenexam/index.html`;
                }
            }, 1000);
        }
    </script>
</body>
</html> 